<?php
use Application\Service\CommonService;
use Zend\Session\Container;
$sessionLogin = new Container('credo');
$common = new CommonService();
$config = new \Zend\Config\Reader\Ini();
$configResult = $config->fromFile(CONFIG_PATH . '/custom.config.ini');
$domain = $configResult["domain"];
class MYPDF extends TCPDF {
     
    //Page header
     public function setHeading($logo,$text) {
       $this->logo = $logo;
       $this->text = $text;
     }
     //Page header
public function Header() {
    // Logo
    //$image_file = K_PATH_IMAGES.'logo_example.jpg';
    //$this->Image($image_file, 10, 10, 15, '', 'JPG', '', 'T', false, 300, '', false, false, 0, false, false, false);
    // Set font
    // if(trim($this->logo)!=''){
    //     if (file_exists('../uploads'. DIRECTORY_SEPARATOR . 'logo'. DIRECTORY_SEPARATOR.$this->logo)) {
    //       $image_file = '../uploads'. DIRECTORY_SEPARATOR . 'logo'. DIRECTORY_SEPARATOR.$this->logo;
    //       $this->Image($image_file,20, 13, 15, '', '', '', 'T', false, 300, '', false, false, 0, false, false, false);
    //     }
    // }
    $this->SetFont('helvetica', 'B', 7);
    $this->writeHTMLCell(30,0,16,28,$this->text, 0, 0, 0, true, 'A', true);
    $this->SetFont('helvetica', '', 18);
    $this->writeHTMLCell(0,0,10,18,'HIV RECENCY RESULTS', 0, 0, 0, true, 'C', true);
    $this->writeHTMLCell(0,0,15,36,'<hr>', 0, 0, 0, true, 'C', true);
}
 
     // Page footer
     public function Footer() {
         // Position at 15 mm from bottom
         $this->SetY(-15);
         // Set font
         $this->SetFont('helvetica', '', 8);
         // Page number
         $this->Cell(0, 10, 'Page '.$this->getAliasNumPage().'/'.$this->getAliasNbPages(), 0, false, 'C', 0, '', 0, false, 'T', 'M');
     }
  }
  $pdf = new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
  $pdf->setHeading('','');
  $pdf->setPageOrientation('L');
  // set document information
    $pdf->SetCreator(PDF_CREATOR);
    $pdf->SetTitle('Vl Result Mail');
    //$pdf->SetSubject('TCPDF Tutorial');
    //$pdf->SetKeywords('TCPDF, PDF, example, test, guide');

    // set default header data
    $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH,PDF_HEADER_TITLE, PDF_HEADER_STRING);

    // set header and footer fonts
    $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '',PDF_FONT_SIZE_MAIN));
    $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '',PDF_FONT_SIZE_DATA));

    // set default monospaced font
    $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

    // set margins
    $pdf->SetMargins(PDF_MARGIN_LEFT,PDF_MARGIN_TOP+14,PDF_MARGIN_RIGHT);
    $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
    $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

    // set auto page breaks
    $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

    // set image scale factor
    $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

    // set font
  $pdf->SetFont('helvetica', '', 8);
  $pdf->AddPage();
  $pdfContent = '';
  $downloadFile1 = '';
  $pdfContent.='<table style="width;100%;border:1px solid #333;padding:0px 2px 2px 2px;" cellspacing="0" cellpadding="2">';
           $pdfContent.='<tr>';
           $pdfContent.='<td style="border:2px solid #333;"><strong>Sample ID</strong></td>';
           $pdfContent.='<td style="border:2px solid #333;"><strong>Patient ID</strong></td>';
           $pdfContent.='<td style="border:2px solid #333;"><strong>Facility Name</strong></td>';
           $pdfContent.='<td style="border:2px solid #333;"><strong>HIV Diagnosis Date</strong></td>';
           $pdfContent.='<td style="border:2px solid #333;"><strong>Final Outcome</strong></td>';
           $pdfContent.='<td style="border:1px solid #333;"><strong>HIV Recency Test Date</strong></td>';
           $pdfContent.='<td style="border:1px solid #333;"><strong>Control Line</strong></td>';
           $pdfContent.='<td style="border:1px solid #333;"><strong>Positive Verification Line</strong></td>';
           $pdfContent.='<td style="border:1px solid #333;"><strong>Long Verification Line</strong></td>';
           $pdfContent.='<td style="border:1px solid #333;"><strong>Viral Load Result</strong></td>';
           $pdfContent.='<td style="border:1px solid #333;"><strong>Viral Load Test Date</strong></td>';
          
           $pdfContent.='</tr>';
           for($s=0;$s<count($result);$s++){
            $pdfContent.='<tr>';
            $pdfContent.='<td style="border:2px solid #333;">'.$result[$s]['sample_id'].'</td>';
            $pdfContent.='<td style="border:2px solid #333;">'.$result[$s]['patient_id'].'</td>';
            $pdfContent.='<td style="border:2px solid #333;">'.$result[$s]['facility_name'].'</td>';
            $pdfContent.='<td style="border:2px solid #333;">'.$result[$s]['hiv_diagnosis_date'].'</td>';
            $pdfContent.='<td style="border:2px solid #333;">'.$result[$s]['final_outcome'].'</td>';
            $pdfContent.='<td style="border:1px solid #333;">'.$result[$s]['hiv_recency_test_date'].'</td>';
            $pdfContent.='<td style="border:1px solid #333;">'.$result[$s]['control_line'].'</td>';
            $pdfContent.='<td style="border:1px solid #333;">'.$result[$s]['positive_verification_line'].'</td>';
            $pdfContent.='<td style="border:1px solid #333;">'.$result[$s]['long_term_verification_line'].'</td>';
            $pdfContent.='<td style="border:1px solid #333;">'.$result[$s]['vl_result'].'</td>';
            $pdfContent.='<td style="border:1px solid #333;">'.$result[$s]['vl_test_date'].'</td>';
           
            $pdfContent.='</tr>';
           }
           $pdfContent.='</table>';
           $pdf->writeHTML($pdfContent);
          $pdf->lastPage();
          $filename = 'vlsm-result-' . date('d-M-Y-H-i-s') . '.pdf';
          $filePath = TEMP_UPLOAD_PATH . DIRECTORY_SEPARATOR.$filename;
          $downloadFile1 = TEMP_UPLOAD_PATH . DIRECTORY_SEPARATOR.$filename;
//$pdf->Output('example_003.pdf', 'I');
$pdf->Output($filePath, "F");
?>

<div class="bg-body-light">
     <div class="content content-full">
          <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
               <h1 class="flex-sm-fill font-size-h2 font-w400 mt-2 mb-0 mb-sm-2">Email Results</h1>
               <nav class="flex-sm-00-auto ml-sm-3" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                         <li class="breadcrumb-item active" aria-current="page"> Email Results</li>
                    </ol>
               </nav>
          </div>
     </div>
</div>
<div class="content">
     <div class="block block-rounded block-bordered">
          <div class="block-header block-header-default">
               <h3 class="block-title">Send Results by Email</h3>
          </div>
          <div class="block-content">
               <div class="col-md-12 table-responsive">
               <form name="emailInformation" id="emailInformation"  class="mb-5" action="<?php echo $this->url('vl-data', array('action' => 'email-result-pdf')); ?>" method="post">
                    <div class="form-group row">
                    <table class="table table-bordered table-striped" style="width:18%;margin-left:41%;">
                         <thead>
                           <tr>
                             <th style="text-align:center;background-color:#71b9e2;color:#FFFFFF;">Selected Sample(s)</th>
                           </tr>
                         </thead>
                         <tbody>
                           <?php
                           for($s=0;$s<count($result);$s++){
                           ?>
                            <tr>
                             <td style="text-align:left;"><?php echo $result[$s]['sample_id']; ?></td>
                            </tr>
                           <?php }  ?>
                         </tbody>
                     </table>
                    </div>

                    <div class="row items-push">
                        <div class="col-lg-7 offset-lg-4">
                        <input type="hidden" name="pdfFile" value="<?php echo $downloadFile1;?>"/>
                        <input type="hidden" name="emailResultFields" value='<?php echo $formFields;?>'/>
                            <a href="<?php echo $this->url('vl-data', array('action' => 'email-result')); ?>" class="btn btn-danger" >Cancel</a>&nbsp;
                            <button type="submit" class="btn btn-primary" onclick="validateNow();return false;"><i class="fa fa-fw fa-check"></i> Send</button>
                        </div>
                        <div class="col-lg-7 offset-lg-4">
                            <p style="margin-top:10px;"><a class="send-mail" href="/vl-data/download-result-pdf/<?php echo $filename; ?>" style="text-decoration:none;">Click here to download the PDF</a></p>
                        </div>
                    </div>
                </form>
               </div>
          </div>
     </div>
</div>